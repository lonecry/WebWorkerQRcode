<!DOCTYPE html>
<html>
<head>
    <title>Web Worker生成二维码</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="creator.css">
</head>
<body>
    <h2>Web Worker生成二维码</h2>
    <textarea id="qrUrl" >Hello World,I am QR code!</textarea>
    <p>
        纠错级别:
        <select id="ecclevel">
            <option value="1">L水平 7% 的字码可被修正</option>
            <option value="2">M水平 15% 的字码可被修正</option>
            <option value="3">Q水平 25% 的字码可被修正</option>
            <option value="4">H水平 30% 的字码可被修正</option>
        </select>
    </p>
    <button onclick="createQR();">点我生成二维码</button>
    <canvas id="code"></canvas>
    <p id="p1" style="color: #18a305;font-size: 16px"></p>
</body>
</html>
<script type="text/javascript" charset="utf-8">


    //二维码详细信息
    var qrUrl = document.getElementById("qrUrl");//具体内容(节点)
    var qrecclevel = document.getElementById("ecclevel");//纠错等级

    function createQR ()  {//生成二维码方法

        var t1,t2,t3;
        t1 = new Date();
        var worker = new Worker("SunWenQR.js");
        var pre = Object();
        pre.url = qrUrl.value;//具体内容(从节点取值)
        pre.ecclevel = qrecclevel.value;//输出类型

        console.log("1. 发送到worker线程");

        worker.postMessage(pre);
        worker.onmessage = function(e) {

            console.log("4. 主线程收到");

            var width = Math.sqrt(e.data.length);
            var qf = e.data;
            canvasWrite(qf, width);
            function canvasWrite(qf, width) {
                console.time('渲染用时');
                t2 = new Date();
                //设置画布
                var size = 200;
                var qrc = document.getElementById("code").getContext("2d");
                qrc.canvas.width = qrc.canvas.height = size+10;
                qrc.clearRect(0,0,size,size);

                var px=Math.round(size/width);

                //每一行用fillRect 填充
                for( var i = 0; i < width; i++ ) {
                    for( var j = 0; j < width; j++ ) {
                        if( qf[i*width+j] ) {
                            qrc.fillRect(px*i,px*j,px,px);
                        }
                    }
                }
                t3 = new Date();
            }
            console.timeEnd('渲染用时');
            console.log("总共用时"+(t3-t1)+"ms");
            document.getElementById("p1").innerHTML="====  渲染   "+(t3-t2)+"   毫秒   ========   总 共   "+(t3-t1)+"   毫秒   ====";
        };

    }
</script>