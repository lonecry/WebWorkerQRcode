<!DOCTYPE html>
<html>
<head>
    <title>Web Worker生成二维码</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" href="creator.css">
</head>
<body>
    <h2>Web Worker生成二维码</h2>
    <textarea id="qrUrl" ></textarea>
    <p>
        纠错级别:
        <select id="ecclevel">
            <option value="1">L水平 7% 的字码可被修正</option>
            <option value="2">M水平 15% 的字码可被修正</option>
            <option value="3">Q水平 25% 的字码可被修正</option>
            <option value="4">H水平 30% 的字码可被修正</option>
        </select>
    </p>
    <button onclick="createQR();">点我生成二维码</button>
    <canvas id="code"></canvas>
</body>
</html>
<script type="text/javascript" charset="utf-8">


    //二维码详细信息
    var qrUrl = document.getElementById("qrUrl");//具体内容(节点)
    var qrecclevel = document.getElementById("ecclevel");//纠错等级

    function utf16to8(str) {// 中文编码问题
        var out, i, len, c;
        out = "";
        len = str.length;
        for (i = 0; i < len; i++) {
            c = str.charCodeAt(i);
            if ((c >= 0x0001) && (c <= 0x007F)) {
                out += str.charAt(i);
            } else if (c > 0x07FF) {
                out += String.fromCharCode(0xE0 | ((c >> 12) & 0x0F));
                out += String.fromCharCode(0x80 | ((c >> 6) & 0x3F));
                out += String.fromCharCode(0x80 | ((c >> 0) & 0x3F));
            } else {
                out += String.fromCharCode(0xC0 | ((c >> 6) & 0x1F));
                out += String.fromCharCode(0x80 | ((c >> 0) & 0x3F));
            }
        }
        return out;
    }

    function createQR ()  {//生成二维码方法

        console.time('总共用时');

        console.time('实例时间');

        var worker = new Worker("./SunWenQR.js");//实例化一个worker 对象

        console.timeEnd('实例时间');


        var pre = {};
        pre.url = utf16to8(qrUrl.value);//具体内容(从节点取值)
        pre.ecclevel = qrecclevel.value;//输出类型

        worker.postMessage(pre);

        worker.onmessage = function(e) {

            var width = Math.sqrt(e.data.length);
            var qf = e.data;
            canvasWrite(qf, width);
            function canvasWrite(qf, width) {
                console.time('渲染用时');
                //设置画布
                var size = 400;
                var qrc = document.getElementById("code").getContext("2d");
                qrc.canvas.width = qrc.canvas.height = size;

                var px=size/width;
                px = Math.round(px);

                for( var i = 0; i < width; i++ ) {
                    for( var j = 0; j < width; j++ ) {
                        if( qf[i*width+j] ) {
                            qrc.fillRect(px*j,px*i,px,px);
                        }
                    }
                }

            }

            console.timeEnd('渲染用时');
            console.timeEnd('总共用时');
        };


    }

</script>